{
  "filename": "build-docker-image.md",
  "__html": "<h3>如何构建 DolphinScheduler 的 docker 镜像</h3>\n<p>你能够在类 Unix 系统和 Windows 系统中构建一个 docker 镜像。</p>\n<p>类 Unix 系统, 如下:</p>\n<pre><code class=\"language-bash\">$ <span class=\"hljs-built_in\">cd</span> path/incubator-dolphinscheduler\n$ sh ./docker/build/hooks/build\n</code></pre>\n<p>Windows系统, 如下:</p>\n<pre><code class=\"language-bat\"><span class=\"hljs-function\">c:\\<span class=\"hljs-title\">incubator</span>-<span class=\"hljs-title\">dolphinscheduler</span>&gt;.\\<span class=\"hljs-title\">docker</span>\\<span class=\"hljs-title\">build</span>\\<span class=\"hljs-title\">hooks</span>\\<span class=\"hljs-title\">build.bat</span>\n</span></code></pre>\n<p>如果你不理解这些脚本 <code>./docker/build/hooks/build</code> <code>./docker/build/hooks/build.bat</code>，请阅读里面的内容。</p>\n<h2>环境变量</h2>\n<p>DolphinScheduler 映像使用了几个容易遗漏的环境变量。虽然这些变量不是必须的，但是可以帮助你更容易配置镜像并根据你的需求定义相应的服务配置。</p>\n<p><strong><code>DATABASE_TYPE</code></strong></p>\n<p>配置<code>database</code>的<code>TYPE</code>， 默认值 <code>postgresql</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_DRIVER</code></strong></p>\n<p>配置<code>database</code>的<code>DRIVER</code>， 默认值 <code>org.postgresql.Driver</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_HOST</code></strong></p>\n<p>配置<code>database</code>的<code>HOST</code>， 默认值 <code>127.0.0.1</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_PORT</code></strong></p>\n<p>配置<code>database</code>的<code>PORT</code>， 默认值 <code>5432</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_USERNAME</code></strong></p>\n<p>配置<code>database</code>的<code>USERNAME</code>， 默认值 <code>root</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_PASSWORD</code></strong></p>\n<p>配置<code>database</code>的<code>PASSWORD</code>， 默认值 <code>root</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_DATABASE</code></strong></p>\n<p>配置<code>database</code>的<code>DATABASE</code>， 默认值 <code>dolphinscheduler</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DATABASE_PARAMS</code></strong></p>\n<p>配置<code>database</code>的<code>PARAMS</code>， 默认值 <code>characterEncoding=utf8</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>、<code>api-server</code>、<code>alert-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>DOLPHINSCHEDULER_ENV_PATH</code></strong></p>\n<p>任务执行时的环境变量配置文件， 默认值 <code>/opt/dolphinscheduler/conf/env/dolphinscheduler_env.sh</code>。</p>\n<p><strong><code>DOLPHINSCHEDULER_DATA_BASEDIR_PATH</code></strong></p>\n<p>用户数据目录, 用户自己配置, 请确保这个目录存在并且用户读写权限， 默认值 <code>/tmp/dolphinscheduler</code>。</p>\n<p><strong><code>ZOOKEEPER_QUORUM</code></strong></p>\n<p>配置<code>master-server</code>和<code>worker-serverr</code>的<code>Zookeeper</code>地址, 默认值 <code>127.0.0.1:2181</code>。</p>\n<p><strong>注意</strong>: 当运行<code>dolphinscheduler</code>中<code>master-server</code>、<code>worker-server</code>这些服务时，必须指定这个环境变量，以便于你更好的搭建分布式服务。</p>\n<p><strong><code>MASTER_EXEC_THREADS</code></strong></p>\n<p>配置<code>master-server</code>中的执行线程数量，默认值 <code>100</code>。</p>\n<p><strong><code>MASTER_EXEC_TASK_NUM</code></strong></p>\n<p>配置<code>master-server</code>中的执行任务数量，默认值 <code>20</code>。</p>\n<p><strong><code>MASTER_HEARTBEAT_INTERVAL</code></strong></p>\n<p>配置<code>master-server</code>中的心跳交互时间，默认值 <code>10</code>。</p>\n<p><strong><code>MASTER_TASK_COMMIT_RETRYTIMES</code></strong></p>\n<p>配置<code>master-server</code>中的任务提交重试次数，默认值 <code>5</code>。</p>\n<p><strong><code>MASTER_TASK_COMMIT_INTERVAL</code></strong></p>\n<p>配置<code>master-server</code>中的任务提交交互时间，默认值 <code>1000</code>。</p>\n<p><strong><code>MASTER_MAX_CPULOAD_AVG</code></strong></p>\n<p>配置<code>master-server</code>中的CPU中的<code>load average</code>值，默认值 <code>100</code>。</p>\n<p><strong><code>MASTER_RESERVED_MEMORY</code></strong></p>\n<p>配置<code>master-server</code>的保留内存，默认值 <code>0.1</code>。</p>\n<p><strong><code>MASTER_LISTEN_PORT</code></strong></p>\n<p>配置<code>master-server</code>的端口，默认值 <code>5678</code>。</p>\n<p><strong><code>WORKER_EXEC_THREADS</code></strong></p>\n<p>配置<code>worker-server</code>中的执行线程数量，默认值 <code>100</code>。</p>\n<p><strong><code>WORKER_HEARTBEAT_INTERVAL</code></strong></p>\n<p>配置<code>worker-server</code>中的心跳交互时间，默认值 <code>10</code>。</p>\n<p><strong><code>WORKER_FETCH_TASK_NUM</code></strong></p>\n<p>配置<code>worker-server</code>中的获取任务的数量，默认值 <code>3</code>。</p>\n<p><strong><code>WORKER_MAX_CPULOAD_AVG</code></strong></p>\n<p>配置<code>worker-server</code>中的CPU中的最大<code>load average</code>值，默认值 <code>100</code>。</p>\n<p><strong><code>WORKER_RESERVED_MEMORY</code></strong></p>\n<p>配置<code>worker-server</code>的保留内存，默认值 <code>0.1</code>。</p>\n<p><strong><code>WORKER_WEIGHT</code></strong></p>\n<p>配置<code>worker-server</code>的权重，默认之<code>100</code>。</p>\n<p><strong><code>WORKER_LISTEN_PORT</code></strong></p>\n<p>配置<code>worker-server</code>的端口，默认值 <code>1234</code>。</p>\n<p><strong><code>WORKER_GROUP</code></strong></p>\n<p>配置<code>worker-server</code>的分组，默认值 <code>default</code>。</p>\n<p><strong><code>XLS_FILE_PATH</code></strong></p>\n<p>配置<code>alert-server</code>的<code>XLS</code>文件的存储路径，默认值 <code>/tmp/xls</code>。</p>\n<p><strong><code>MAIL_SERVER_HOST</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务地址，默认值 <code>空</code>。</p>\n<p><strong><code>MAIL_SERVER_PORT</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务端口，默认值 <code>空</code>。</p>\n<p><strong><code>MAIL_SENDER</code></strong></p>\n<p>配置<code>alert-server</code>的邮件发送人，默认值 <code>空</code>。</p>\n<p><strong><code>MAIL_USER=</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务用户名，默认值 <code>空</code>。</p>\n<p><strong><code>MAIL_PASSWD</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务用户密码，默认值 <code>空</code>。</p>\n<p><strong><code>MAIL_SMTP_STARTTLS_ENABLE</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务是否启用TLS，默认值 <code>true</code>。</p>\n<p><strong><code>MAIL_SMTP_SSL_ENABLE</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务是否启用SSL，默认值 <code>false</code>。</p>\n<p><strong><code>MAIL_SMTP_SSL_TRUST</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务SSL的信任地址，默认值 <code>空</code>。</p>\n<p><strong><code>ENTERPRISE_WECHAT_ENABLE</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务是否启用企业微信，默认值 <code>false</code>。</p>\n<p><strong><code>ENTERPRISE_WECHAT_CORP_ID</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务企业微信<code>ID</code>，默认值 <code>空</code>。</p>\n<p><strong><code>ENTERPRISE_WECHAT_SECRET</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务企业微信<code>SECRET</code>，默认值 <code>空</code>。</p>\n<p><strong><code>ENTERPRISE_WECHAT_AGENT_ID</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务企业微信<code>AGENT_ID</code>，默认值 <code>空</code>。</p>\n<p><strong><code>ENTERPRISE_WECHAT_USERS</code></strong></p>\n<p>配置<code>alert-server</code>的邮件服务企业微信<code>USERS</code>，默认值 <code>空</code>。</p>\n<p><strong><code>FRONTEND_API_SERVER_HOST</code></strong></p>\n<p>配置<code>frontend</code>的连接<code>api-server</code>的地址，默认值 <code>127.0.0.1</code>。</p>\n<p><strong>Note</strong>: 当单独运行<code>api-server</code>时，你应该指定<code>api-server</code>这个值。</p>\n<p><strong><code>FRONTEND_API_SERVER_PORT</code></strong></p>\n<p>配置<code>frontend</code>的连接<code>api-server</code>的端口，默认值 <code>12345</code>。</p>\n<p><strong>Note</strong>: 当单独运行<code>api-server</code>时，你应该指定<code>api-server</code>这个值。</p>\n<h2>初始化脚本</h2>\n<p>如果你想在编译的时候或者运行的时候附加一些其它的操作及新增一些环境变量，你可以在<code>/root/start-init-conf.sh</code>文件中进行修改，同时如果涉及到配置文件的修改，请在<code>/opt/dolphinscheduler/conf/*.tpl</code>中修改相应的配置文件</p>\n<p>例如，在<code>/root/start-init-conf.sh</code>添加一个环境变量<code>API_SERVER_PORT</code>：</p>\n<pre><code>export API_SERVER_PORT=5555\n</code></pre>\n<p>当添加以上环境变量后，你应该在相应的模板文件<code>/opt/dolphinscheduler/conf/application-api.properties.tpl</code>中添加这个环境变量配置:</p>\n<pre><code>server.port=${API_SERVER_PORT}\n</code></pre>\n<p><code>/root/start-init-conf.sh</code>将根据模板文件动态的生成配置文件：</p>\n<pre><code class=\"language-sh\"><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;generate app config&quot;</span>\nls <span class=\"hljs-variable\">${DOLPHINSCHEDULER_HOME}</span>/conf/ | grep <span class=\"hljs-string\">&quot;.tpl&quot;</span> | <span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> line; <span class=\"hljs-keyword\">do</span>\n<span class=\"hljs-built_in\">eval</span> <span class=\"hljs-string\">&quot;cat &lt;&lt; EOF\n<span class=\"hljs-subst\">$(cat ${DOLPHINSCHEDULER_HOME}/conf/${line})</span>\nEOF\n&quot;</span> &gt; <span class=\"hljs-variable\">${DOLPHINSCHEDULER_HOME}</span>/conf/<span class=\"hljs-variable\">${line%.*}</span>\n<span class=\"hljs-keyword\">done</span>\n\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;generate nginx config&quot;</span>\nsed -i <span class=\"hljs-string\">&quot;s/FRONTEND_API_SERVER_HOST/<span class=\"hljs-variable\">${FRONTEND_API_SERVER_HOST}</span>/g&quot;</span> /etc/nginx/conf.d/dolphinscheduler.conf\nsed -i <span class=\"hljs-string\">&quot;s/FRONTEND_API_SERVER_PORT/<span class=\"hljs-variable\">${FRONTEND_API_SERVER_PORT}</span>/g&quot;</span> /etc/nginx/conf.d/dolphinscheduler.conf\n</code></pre>\n",
  "link": "/dist/zh-cn/docs/1.3.4/user_doc/build-docker-image.html",
  "meta": {}
}